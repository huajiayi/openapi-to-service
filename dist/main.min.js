!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("umi-request"),require("fs"),require("ejs"),require("path")):"function"==typeof define&&define.amd?define(["umi-request","fs","ejs","path"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).View=t(e.request,e.fs,e.ejs,e.path)}(this,(function(e,t,r,n){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=i(e),a=i(t),o=i(r);const c=e=>e.split("<").map((e=>e.replace(/>/g,"").replace(/\[\]/g,""))),p=e=>e.replace(/<T>/g,""),l=(e,t)=>{if(!e)return"any";const{type:r}=e;if(!r&&e.originalRef)return e.originalRef;return["int64","integer","long","float","double","number","int","float","double","int32","int64"].includes(r)?"number":["Date","date","dateTime","date-time","datetime"].includes(r)||["string","email","password","url","byte","binary"].includes(r)?"string":"boolean"===r?"boolean":"object"===r?t?"T":e.originalRef??e.additionalProperties?.type??"any":"array"===r?t?"T[]":`${e.items.originalRef??l(e.items)}[]`:"any"},u=e=>e.includes("{")?`\`${e.replace(/{/g,"${pathVars.")}\``:`'${e}'`,d=(e,t)=>{const r=(e,r)=>{const n=e[200];if(n.schema?.type)return l(n.schema);if(n.schema?.originalRef){const e=n.schema?.originalRef?.replace(/«/g,"<").replace(/»/g,">"),i=c(e);if(1===i.length&&r.includes(e))return e+"<any>";const s=t.map((e=>p(e.name)));for(let e=0;e<i.length;e++)s.includes(i[e])||(i[e]="any");return(e=>1===e.length?e[0]:`${e.join("<")}${e.slice(1).map((()=>">")).join("")}`)(i)}return"any"},n=[];return Object.keys(e.paths).forEach((i=>{const s=e.paths[i];Object.keys(s).forEach((a=>{const o=s[a],c=((e,t)=>{if(!e||0===e.length)return[];if("body"===e[0]?.in){const r=e?.[0]?.schema.originalRef,n=t[r]?.properties;return Object.keys(n).map((e=>{const t=n[e];return{in:"body",name:e,type:l(t,!1),description:t.description,required:!1}}))}return e.map((e=>({in:e.in,name:e.name,type:l(e,!1),description:e.description,required:e.required})))})(o.parameters,e.definitions);n.push({tag:o.tags?.[0],name:o.operationId,description:o.summary,request:{url:i,urlText:u(i),method:a.toUpperCase(),params:c,filter:{path:c.filter((e=>"path"===e.in)),query:c.filter((e=>"query"===e.in)),body:c.filter((e=>"body"===e.in)),formdata:c.filter((e=>"formdata"===e.in))}},response:{type:r(o.responses,t.filter((e=>e.isGenerics)).map((e=>p(e.name))))}})}))})),n},f=(e,t)=>new Promise(((r,n)=>{o.default.renderFile(e,t,{},((e,t)=>{e&&n(e.message),r(t)}))})),m=async(e,t)=>{const r=(e=>{const t=e.definitions||{},r=new Set;Object.keys(t).forEach((e=>{const t=e.split("«");t.pop(),t.forEach((e=>r.add(e)))}));const n=[];return Object.keys(t).forEach((e=>{let i=e;const s=c((e=>e.replace(/«/g,"<").replace(/»/g,">"))(e));s.length>1&&(i=s[0]);const a=t[e];var o,u;if(a.properties&&!n.some((e=>p(e.name)===i))){console.log(i);const e=r.has(i);n.push({isGenerics:e,name:e?`${i}<T>`:i,description:a.description||"",params:(o=a.properties,u=e,Object.keys(o).map((e=>{const t=o[e];return{isGenerics:u,name:e,type:l(t,u),description:t.description,required:!1}})))})}})),n})(e),i=n.resolve(__dirname,"../","src","template","type.ejs"),s=await f(i,{types:r}),o=n.resolve(t,"typings.ts");a.default.writeFileSync(o,s);const u=d(e,r),m=new Map;e.tags?.forEach((e=>{m.set(e.name,[])})),u.forEach((e=>m.get(e.tag)?.push(e))),m.forEach((async(e,i)=>{const s=n.resolve(__dirname,"../","src","template","umi-request.ejs"),o=new Set;e.forEach((e=>{e.request.params.forEach((e=>{const t=e.type.replace(/\[\]/g,"");r.some((e=>p(e.name)===t))&&o.add(t)})),c(e.response.type).forEach((e=>{r.some((t=>p(t.name)===e))&&o.add(e)}))}));const l=await f(s,{deps:o,apis:e}),u=n.resolve(t,`${i}.ts`);a.default.writeFileSync(u,l)}))};return async e=>{const{data:t,url:r,outputDir:n}=e;if(!t&&!r)throw new Error("please input either data or url!");if(!n)throw new Error("please input outputDir!");let i={};r&&(i=await s.default.get(r)),t&&(i=JSON.parse(t)),m(i,n)}}));